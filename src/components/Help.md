<script>
    import Link from '../components/Link.svelte';
    import {ofp} from '../stores.js';
    import plugins from "../plugins.json";
    $: ogimetURL = ($ofp) ? $ofp.ogimetData.url: 'http://www.ogimet.com';
    const cbName = window.atob("Q2FydGFCb3NzeQ==");
</script>

## Pr√©ambule

OFP2MAP est une application PWA (ou Web Application), elle peut √™tre lanc√©e soit depuis un navigateur, soit depuis l'√©cran d'accueil de l'iPad. Initialement, simple convertisseur de l'OFP en KML, OFP2MAP est devenu une vraie application de cartographie. OFP2MAP n√©cessite des navigateurs r√©cents pour fonctionner. Safari 14 iOS/Mac est compatible, Chrome 83 fonctionne aussi.

L'OFP ne transite sur aucun serveur, seule une route calcul√©e (bas√©e sur au plus 21 stations m√©t√©o) est transmise √† l'h√©bergeur du proxy (voir plus bas) puis √† Ogimet.com pour r√©cup√©rer le Gramet. L'app ne collecte aucune donn√©e.

## Utilisation

1. Dans Pilot Mission, onglet ¬´Dossier de vol¬ª, affichez le PDF nomm√© "Dossier de vol OFP". Sur la gauche, cliquez sur le carr√© avec une fl√®che vers le haut. Choisissez ¬´Enregistrer dans Fichiers¬ª. Dans l'app, c'est cet OFP qu'il faut ensuite s√©lectionner.

2. La carte par d√©faut d√©pend de la distance: {cbName} 2020, puis Mercator jusqu'√† 1500nm puis LAMBERT, il est possible sur la carte, en haut √† gauche, de basculer sur d'autres projections&#8239;:
    - LAMBERT NORTH (parall√®les s√©cants N30 et N65) est recommand√©e au-dessus du N40
    - LAMBERT SOUTH & PACIFIC (s√©cants N30 et S15 ) sont recommand√©es sous N30
    - THE WORLD permet de disposer d'un Atlas off-line, c'est une projection Times
    - MERCATOR est une Web Mercator avec un th√®me est inspir√© des cartes VFR. Il y a 12 niveaux de zoom, dont 6 disponibles off-line
    - =Physique= est un Atlas physique bas√© sur une projection Equal Earth (qui montre les continents et les pays √† leur taille r√©elle) avec des √©tiquettes en fran√ßais (par Tom Patterson).
    - {cbName} 2020 est une carte VFR, elle couvre France/Belgique/Luxembourg/Suisse et {window.atob("VmluY2VudCBCb3NzeQ==")} a autoris√© son utilisation. Sur cette carte, d√©j√† tr√®s dense en informations, la route Gramet, l'orthodromie et les FIR sont d√©sactiv√©es. La derni√®re version est disponible sur <Link href="{`https://www.${cbName.toLowerCase()}.com`}">{cbName}.com</Link>.


3. Navigation dans la carte: on peut avec un doigt d√©placer la carte, zoomer ou orienter la carte avec deux doigts.  
__<big>‚òû</big> Il est aussi possible de modifier l'angle de vue en balayant de bas en haut avec deux doigts__.

## M√©mo visuel

<img src="./images/map-help.webp" alt="m√©mo visuel" id="memovisuel"><br/>

## R√©glages des calques

<figure>![layers settings help](./images/layers-settings.webp)<figcaption>R√©glages des calques</figcaption></figure>La carte, en haut √† droite, dispose d'un bouton pour personnaliser les calques et les couleurs. Un calque contient un type d'information, par exemple les cercles ETOPS, les FIR r√©glement√©es, les tracks, la route...
Il est possible d'afficher ou de masquer chaque calque en utilisant la coche qui pr√©c√®de son nom. La plupart des calques permettent de choisir la couleur et l'opacit√©.
Pour les a√©roports (le type avion est d√©termin√© dans l'OFP), il est possible de choisir entre 3 styles: couleur du statut, vert/rouge ou m√©dical. Si vous optez pour le second, le statut reste accessible en cliquant sur un terrain (popup). Le style m√©dical n'affiche que les terrains de support m√©dical.

Trois boutons permettent la sauvegarde, la restauration ou un retour aux valeurs par d√©faut. Le bouton RESTAURER permet, apr√®s avoir fait des modifications temporaires (non sauvegard√©es), de revenir rapidement aux r√©glages pr√©c√©dents.

Enfin, un mode FOCUS est disponible, par d√©faut il n'affiche que la route. Pour une utilisation plus avanc√©e, vous pouvez l'utiliser comme un deuxi√®me jeu de r√©glages. En effet, vous pouvez en mode FOCUS modifier tous les r√©glages, et les r√©glages du mode FOCUS sont sauvegard√©s √† part. Pour quitter le mode FOCUS, vous pouvez cliquer une deuxi√®me fois sur le bouton FOCUS ou utiliser le bouton QUITTER LE MODE FOCUS.

Pour vous entra√Æner, je vous recommande de modifier la couleur des terrains en vert/rouge et de sauvegarder votre choix.

## Particularit√©s de l'iPad

OFP2MAP ne peut √™tre lanc√© que depuis l'√©cran d'accueil, l'application se lance en plein √©cran. On ne peut pas recharger la page comme dans un navigateur&#8239;: il faudra pour cela aller dans le menu d'aide (cet √©cran) ou un bouton sp√©cifique sera affich√© en haut.

Pour partager le lien vers OFP2MAP, utilisez le bouton situ√© en haut sur cette page, ou le lien situ√© sous le logo sur la page d'accueil, puis utilisez AirDrop. {#if navigator.standalone !== true}Pour m√©moire, dans un navigateur, il suffit de partager l'url ou <Link href="http://flyingeek.github.io/lido-online/index.html">ce lien</Link>.{/if}

√Ä noter que parfois, des bugs d'affichage peuvent appara√Ætre&#8239;:  lorsque l'on retourne sur l'app, l'app est zoom√©e, il faut alors juste d√©zoomer en utilisant un pinch de deux doigts sur la barre de menu. Il est aussi possible de tuer l'app,  m√™me en mode d√©connect√©, pour la relancer.

## GRAMET

Le GRAMET est un m√©t√©ogramme repr√©sentant le temps et l'espace. Il indique, en tout point de la route, et √† l'heure de passage estim√©e, une coupe verticale de la m√©t√©o pr√©vue.
Le GRAMET est r√©alis√© par <Link href="{ogimetURL}">ogimet.com</Link> √† partir d'une route calcul√©e. Il est possible d'afficher le GRAMET et sa route sur la carte. La route est particuli√®rement utile lors des vols oc√©aniques car il n'y a aucune station en mer.
Pour construire la route du GRAMET, on utilise non pas les waypoints, mais au plus 21 stations m√©t√©o (WMO). Il y a au total 13000 WMO dans le monde. Le GRAMET d√©bute toujours √† l'heure hh:00. Pour un decollage √† 19h30, il d√©butera √† 19h, pour un d√©collage √† 19h31, il d√©butera √† 20h. Pour les OFP anciens, c'est l'heure actuelle qui est envoy√©e. En mode d√©connect√©, OFP2MAP utilise la version du GRAMET qu'il a mis en cache pendant 48h. Apr√®s l'heure de d√©collage initialement pr√©vue, vous pouvez forcer une mise √† jour, soit en rechargeant l'ofp, soit en changeant bri√®vement de page.

Pour afficher le Gramet, cliquez sur sa miniature √† gauche de l'OFP. Pour afficher la route, direction le r√©glage des calques de la carte. Par d√©faut elle est affich√©e en bleu. En fonction de l'heure de d√©collage (modifiable), le Gramet et sa miniature affichent la position avion. Avant l'horaire pr√©vu de d√©collage, un bouton play permet de lancer une animation.

Pour mieux comprendre le GRAMET, je vous conseille son <Link href="http://www.ogimet.com/guia_gramet.phtml.en">Guide d'interpr√©tation</Link>.

## Position estim√©e / GPS

Il est possible d'afficher la position avion sur la carte (bouton en forme de mire). Si vous l'autorisez, la position GPS sera prise en compte. Si la localisation GPS semble ne pas fonctionner (au sol ou en vol avec un gps externe), v√©rifiez que vous n'avez pas d√©sactiv√© la localisation dans iPad / R√©glages / Confidentialit√© / Service de localisation / Sites Safari. Vous devez choisir ¬´Lorsque l'app est active¬ª ou ¬´Demander la prochaine fois¬ª. Le Bouton a deux ou trois positions: OFF, ON centr√©, ON non centr√©. Si, dans la position ON centr√©, vous d√©placez la carte, il passe en ON non centr√©. L'appui suivant le repassera en ON centr√©. Un dernier appui le mettra sur OFF.

En l'absence de GPS, l'avion dans la barre de menu (√† gauche de l'heure de d√©collage) permet d'afficher la position estim√©e. Si la reconnaissance des waypoints s'est bien effectu√©e, les estim√©es de l'OFP seront prises en compte. Sinon, ce sera un simple ratio horaire, merci de me transmettre l'OFP dans ce cas (ce sera signal√© par un avion rouge dans la barre de menu et par l'absence des √©ph√©m√©rides). L'heure de d√©collage est modifiable et permet toujours d'ajuster la position estim√©e.

## ETOPS

La capacit√© ETOPS est determin√©e depuis l'OFP et les cercles sont trac√©s. Un drapeau ETOPS apparait dans le pav√© d'information de l'OFP si le carburant est limitatif (20mn, soit environ 2T de marge sur 777). Pour avoir plus d'informations vous pouvez utiliser un plugin (voir ci-dessous).

## √âph√©m√©rides / Aurore Bor√©ale

Le symbole du widget est dynamique:

- ‚òÄÔ∏è si le soleil est visible pendant le vol
- üåïüåñüåóüåòüåëüåíüåìüåî si la lune est visible pendant le vol
- üî≠ si vous restez dans le noir
- un halo vert se superpose si les conditions sont favorables √† l'observation d'aurores bor√©ales

Le widget affiche √©galement les heures de lever ou de coucher. Un clic r√©v√®le des √©ph√©m√©rides avec 2 timelines. La premi√®re synth√©tise le jour et la nuit le long du vol ainsi que les zones favorables √† l'observation des aurores bor√©ales. La seconde montre les pr√©visions de Kp. Le Kp permet de pr√©dire les aurores bor√©ales. Entre ces deux timelines, la Lune est aussi un objet dynamique: l'angle des cornes va se modifier en fonction de la position estim√©e et cet angle est indiqu√© pour les levers et les couchers. Pour le soleil, l'aube nautique est indiqu√©e, car ce n'est pas tout √† fait la nuit: en vol l'horizon est partiellement discernable, et au sol on distingue encore le relief.

__Pr√©cision des calculs&#8239;:__ si vous avez bien recal√© la position estim√©e d'OFP2MAP sur la carte (en modifiant l'heure de d√©collage), la pr√©cision attendue est de ¬±2¬†min sous 72¬∞ de latitude et de 10¬†min au-del√†. Pour la lune, on est plut√¥t sur une pr√©cision de ¬±5¬†min. Le calcul n'est valable que pour la croisi√®re, reportez vous √† EWAS pour un calcul pr√©cis au d√©part ou √† destination.

__Correction d'altitude&#8239;:__ Si votre niveau de vol est diff√©rent de l'OFP, appliquez une correction de 15s/1000ft pour le soleil. Exemple: FL OFP 400, FL r√©el 360, il faut ajouter 1min pour le lever, et soustraire 1min pour le coucher.

Pour rappel, la chronologie des √©v√©nements pour le soleil est:

<table class="table">
    <thead><tr><th>Angle</th><th>‚ñ≤ Soleil levant</th><th>‚ñº Soleil couchant</th></tr></thead>
    <tbody>
        <tr><td>-0.83¬∞</td><td>‚Üë Lever du soleil (fin aube civile)</td><td>‚Üì Coucher du soleil (d√©but cr√©puscule civil)</td></tr>
        <tr><td>-6¬∞</td><td>‚Üë d√©but aube civile (jour civil)</td><td>‚Üì fin du cr√©puscule civil (d√©but nuit civile)</td></tr>
        <tr><td>-12¬∞</td><td>‚Üë d√©but aube nautique (jour nautique)</td><td>‚Üì fin du cr√©puscule nautique (d√©but nuit nautique)</td></tr>
    </tbody>
</table>

Et pour la lune:

<table class="table moon">
    <thead><tr><th>Jour</th><th>Nom</th><th>H√©misph√®re nord</th><th>H√©misph√®re sud</th></tr></thead>
    <tbody>
        <tr><td>1</td><td>Nouvelle lune</td><td>üåë</td><td>üåë</td></tr>
        <tr><td></td><td>Premier croissant</td><td>üåí</td><td>üåò</td></tr>
        <tr><td>7</td><td>Premier quartier</td><td>üåì</td><td>üåó</td></tr>
        <tr><td></td><td>Lune gibbeuse croissante</td><td>üåî</td><td>üåñ</td></tr>
        <tr><td>14</td><td>Pleine lune</td><td>üåï</td><td>üåï</td></tr>
        <tr><td></td><td>Lune gibbeuse d√©croissante</td><td>üåñ</td><td>üåî</td></tr>
        <tr><td>21</td><td>Dernier quartier</td><td>üåó</td><td>üåì</td></tr>
        <tr><td></td><td>Dernier croissant</td><td>üåò</td><td>üåí</td></tr>
    </tbody>
</table>

## Mode off-line / Cache

Une fois un premier OFP charg√©, il est possible m√™me en mode d√©connect√© de charger un autre OFP pour l'exporter. Le cache de l'App vous permettra de naviguer sur les cartes d√©j√† visualis√©es. Pour mettre en cache les cartes, il suffit de les consulter.

Il existe aussi un bouton de mise en cache&#8239;: le pictogramme ‚Üì situ√© √† droite du s√©lecteur de carte. Sur les cartes LAMBERT, THE WORLD, =Physique= et {cbName}, il mettra en cache la totalit√© de la carte. Sur la MERCATOR, seule la partie de carte incluant la route sera mise en cache.

Les premi√®res mises en cache peuvent prendre du temps&#8239;: sur la Mercator, un vol LC peut n√©cessiter le t√©l√©chargement de 40Mo de donn√©es. Les caches des autres projections utilisent&#8239;: 7Mo pour la NORTH, 4Mo pour la PACIFIC, 7Mo pour la SOUTH, 32Mo pour THE WORLD, 40Mo pour =Physique= et 40Mo pour {cbName}.

## Export / Plugins (Raccourcis)

__Page Export&#8239;:__ Elle permet d'exporter la route et les tracks au format KML, elle dispose de ses propres r√©glages pour g√©n√©rer le KML. Pour l'export il est possible d'ajouter des rep√®res. Les rep√®res sont utiles pour afficher des informations textuelles dans MapsMe ou__ Avenza. Le bouton ¬´ COMME CARTE ¬ª permet de r√©cup√©rer les couleurs choisies pour la carte.

Sur iPad, l'export des fichiers KML affiche une page un peu particuli√®re, utilisez le bouton <svg style="vertical-align: bottom;"><use xlink:href="#share-symbol" /></svg> pour choisir l'app qui recevra le fichier. Cliquez en haut √† gauche sur OK pour revenir √† OFP2MAP. Alternativement, vous pouvez utiliser ¬´ Options... ¬ª pour d√©finir une app qui recevra les fichiers kml par d√©faut et utiliser Ouvrir dans ¬´ nom de l'app ¬ª.

 Un raccourci peut √™tre lanc√© depuis la page Export, il recevra les fichiers KML, la route Lido et le Gramet. Le nom du raccourci est modifiable, il faut que le raccourci soit install√© avant de le lancer.

__Plugins depuis la carte&#8239;:__ Il est aussi possible de lancer des raccourcis ayant acc√®s au contenu de l'OFP depuis le pav√© d'informations du vol dans la barre de menu. Il faut autoriser les raccourcis non fiables dans R√©glages/Raccourcis (apr√®s avoir lanc√© au moins un raccourci "fiable" depuis la Galerie), puis installer le(s) plugin(s).

__Liste des plugins&#8239;:__

{#each Object.entries(plugins) as [name, {url, description, version}]}
    - <Link href="{url}">{name} v{version}</Link> {description}
{/each}

## Mise √† jour

L'app d√©tecte les mises √† jour automatiquement, normalement vous n'avez rien √† faire. Eventuellement un prompt peut
apparaitre vous demandant d'autoriser cette mise √† jour. La version AIRAC et le type avion d√©tect√© dans l'OFP sont affich√©s en bas √† droite de la carte dans le champ d'attribution.

Apr√®s une mise √† jour, les derni√®res nouveaut√©s d'OFP2MAP s'affichent. Le bouton CHANGELOG en haut de cette page permet de consulter l'historique, et vous pouvez aussi consulter la <Link href="https://github.com/flyingeek/lido-online/commits/master">liste des commits</Link> sur GitHub. Je poste les nouveaut√©s importantes dans Yammer/Mapsme et Teams/MyConcorde.

## Cr√©dits

- Les donn√©es terrains/FIR sont fournies par Olivier Ravet forum Yammer/Mapsme
- =Physique= est une carte de Tom Patterson disponible sur <Link href="https://equal-earth.com/physical/">Equal Earth</Link>
- La derni√®re version de la carte {cbName} est disponible sur le site <Link href="{`https://www.${cbName.toLowerCase()}.com`}">{cbName}.com</Link>
- Les autres cartes sont de Jean-Baptiste Denizot forum Yammer/QGIS & Avenza Maps
- Le GRAMET provient du site ogimet.com
- Le site est d√©velopp√© en javascript √† l'aide du framework SVELTE
- La partie serveur (un proxy pour pouvoir r√©cup√©rer l'image du GRAMET) est en python.
- Eric Delord CDB 777 est l'auteur. Le code source est disponible sur GitHub pour <Link href="https://github.com/flyingeek/lido-online">l'app</Link> et <Link href="https://github.com/flyingeek/ofp2map-gramet">le proxy</Link>

## H√©bergement

L'h√©bergement des images est normalement fourni par alwaysdata.com (pack gratuit) mais en raison d'un blacklistage sur le r√©seau internet d'AF, les fonds de cartes sont √† pr√©sent h√©berg√©s sur netlify. Le proxy gramet est lui dor√©navant h√©berg√© sur vercel. Le site est h√©berg√© sur GitHub.

## Liens

- <Link href="https://flyingeek.github.io/flytax/" rel="noopener"><span class="flytax">Fly<span>Tax</span></span></Link> une aide aux calculs des frais professionnels (m√™me auteur).

